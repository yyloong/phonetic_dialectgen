# 讯飞语音识别脚本使用说明

## 功能描述

这个脚本使用讯飞的方言识别API来处理 `shorts` 和 `shorts_noisy` 目录中的WAV音频文件。

## 主要特性

- **自动文件分组**: 根据时间戳自动将PART文件分组
- **状态跟踪**: 避免重复处理已完成的文件
- **错误处理**: 自动重试机制，处理API不稳定的情况
- **详细日志**: 记录处理过程和结果
- **结果保存**: 将识别结果保存到JSON文件

## 使用前准备

1. 安装依赖包:
```bash
pip install websocket-client
```

2. 获取讯飞API密钥:
   - 访问 [讯飞开放平台](https://console.xfyun.cn/)
   - 创建应用并获取 APPID, APIKey, APISecret

3. 配置API密钥:
   编辑 `spark_iat_recognition.py` 文件，找到以下行并填入您的密钥：
   ```python
   app_id = "*********"  # 请填写您的APPID
   api_key = "********************"  # 请填写您的APIKey
   api_secret = "********************"  # 请填写您的APISecret
   ```

## 使用方法

```bash
python spark_iat_recognition.py
```

## 文件处理逻辑

### 文件分组

- 根据文件名的时间戳部分进行分组
- 例如: `2025-07-01_10-48-16_PART0000.wav`, `2025-07-01_10-48-16_PART0001.wav` 会被分为一组

### 状态判断

- `PART0000`: status = 0 (第一帧)
- `PART0001` 到 `PART000X`: status = 1 (中间帧)
- 最后一个PART: status = 2 (最后一帧)

### 序列号

- seq = PART后面的数字 (如 PART0005 的 seq = 5)

## 配置参数

脚本使用以下API参数配置：

```python
iat_params = {
    "language": "zh_cn",      # 语言：中文
    "accent": "mulacc",       # 方言：多方言
    "domain": "slm",          # 领域：通用
    "nbest": 5,               # 句子多候选
    "wbest": 5,               # 词级多候选
    "vinfo": 1,               # 句子级别帧对齐
    "nunum": 0,               # 数字规整关闭
    "ptt": 1,                 # 标点预测开启
    "opt": 2,                 # 输出格式：JSON格式，带属性
    "rlang": "zh-cn",         # 返回简体中文
    "ltc": 1,                 # 不进行中英文筛选
    "result": {
        "encoding": "utf8",
        "compress": "raw",
        "format": "json"
    }
}
```

## 输出文件

### 日志文件

- 格式: `spark_iat_recognition_YYYYMMDD_HHMMSS.log`
- 内容: 处理过程的详细记录

### 结果文件

- 格式: `spark_iat_results_YYYYMMDD_HHMMSS.json`
- 内容: 所有识别结果的JSON格式数据

### 进度文件

- 文件名: `spark_iat_progress.json`
- 内容: 已处理文件的记录，用于避免重复处理

## 错误处理

- **API限制**: 每个请求间隔1秒
- **网络错误**: 自动重试3次，使用指数退避
- **状态保存**: 处理进度实时保存，中断后可继续

## 示例输出

```
2025-01-15 10:30:00 - 开始讯飞语音识别任务
2025-01-15 10:30:00 - 加载了 0 个已处理文件记录
2025-01-15 10:30:00 - 开始处理目录: shorts
2025-01-15 10:30:00 - 找到 85 个wav文件
2025-01-15 10:30:00 - 分组后有 23 个时间戳组
2025-01-15 10:30:01 - 处理组: shorts_2025-07-01_10-48-16 (包含 7 个文件)
2025-01-15 10:30:05 - 识别成功: shorts_2025-07-01_10-48-16
2025-01-15 10:30:05 - 识别结果: 这是识别出的文本内容...
```

## 注意事项

1. **API密钥安全**: 请妥善保管您的API密钥，不要提交到版本控制系统
2. **音频格式**: 确保音频文件是16kHz采样率的WAV格式
3. **网络连接**: 需要稳定的网络连接访问讯飞服务器
4. **处理时间**: 根据文件数量和大小，处理时间可能较长
5. **API限制**: 请注意讯飞API的使用限制和计费规则

## 故障排除

### 常见错误

1. **API密钥错误**: 检查APPID、APIKey、APISecret是否正确
2. **网络连接失败**: 检查网络连接和防火墙设置
3. **文件格式错误**: 确保音频文件是有效的WAV格式
4. **权限问题**: 确保脚本有读取音频文件的权限

### 重新处理

如果需要重新处理某些文件，可以：
1. 删除 `spark_iat_progress.json` 文件（重新处理所有文件）
2. 或编辑该文件，移除特定的已处理记录

## 技术支持

如遇到问题，请检查：
1. 日志文件中的错误信息
2. 讯飞开放平台的API文档
3. 网络连接状态
4. 文件权限设置 