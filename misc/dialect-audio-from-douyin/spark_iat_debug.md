# 讯飞API 401错误排查指南

## 问题现象
```
✗ 测试失败: WebSocket错误: Handshake status 401 Unauthorized
{"message":"HMAC signature cannot be verified: fail to retrieve credential"}
```

## 常见原因和解决方案

### 1. API密钥配置错误（最常见）

**检查步骤：**

1. 登录 [讯飞开放平台控制台](https://console.xfyun.cn/)
2. 找到您的应用 → 查看 → 接口密钥
3. 确认三个密钥的正确性：
   - **APPID**: 8位数字和字母组合
   - **APIKey**: 32位十六进制字符
   - **APISecret**: 32位十六进制字符

**解决方案：**

```bash
# 运行配置验证工具
python debug_api_config.py
```

### 2. 服务未开通

**检查步骤：**

1. 进入控制台 → 应用管理 → 选择您的应用
2. 查看"已开通服务"列表
3. 确认包含"语音听写（流式版）"服务

**解决方案：**

- 如果没有该服务，点击"添加服务"进行开通
- 确认服务状态为"已开通"

### 3. 账户状态问题

**可能的问题：**

- 账户余额不足
- 免费额度已用完
- 账户被暂停

**解决方案：**

- 查看控制台的账户状态和余额
- 充值或等待免费额度重置

### 4. 时间同步问题

**问题描述：**

HMAC签名包含时间戳，如果本地时间与服务器时间相差过大会导致验证失败

**解决方案：**

```bash
# Windows
w32tm /resync

# Linux/Mac
sudo ntpdate -s time.nist.gov
```

### 5. 网络和防火墙问题

**检查步骤：**

1. 确认能够访问 `iat.cn-huabei-1.xf-yun.com`
2. 检查防火墙是否阻止WebSocket连接
3. 确认没有代理服务器干扰

**测试连接：**

```bash
ping iat.cn-huabei-1.xf-yun.com
```

## 快速诊断流程

### 步骤1：配置格式验证

```bash
python debug_api_config.py
```

### 步骤2：连接测试

```bash
python test_spark_api.py
```

### 步骤3：查看详细日志

测试脚本会显示详细的签名过程，帮助定位问题

## 如果问题仍然存在

1. **重新生成API密钥**
   - 控制台 → 应用管理 → 重置密钥
   - 使用新密钥重新测试

2. **检查IP白名单**
   - 如果设置了IP白名单，确认当前IP在允许范围内

3. **联系技术支持**
   - 提供完整的错误日志
   - 说明使用的API密钥（脱敏处理）
   - 描述网络环境

## 成功配置示例

当配置正确时，测试脚本会显示：
```
✓ 测试成功: 连接成功！API配置正确。
```

然后就可以正常使用 `spark_iat_recognition.py` 进行语音识别了。

## 注意事项

1. **密钥安全**：不要在公共场所或版本控制中暴露API密钥
2. **使用限制**：注意API的调用频率和并发限制
3. **计费规则**：了解服务的计费方式，避免意外费用
4. **服务状态**：定期检查服务状态，确保正常运行
 