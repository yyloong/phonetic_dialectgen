<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>🗣️ TTS Demo</title>
</head>
<body>
    <h1>🗣️ TTS Demo</h1>
    <input type="text" id="inputText" placeholder="请输入要转换的文本">
    <br><br>
    <input type="radio" id="mandarin" name="language" value="mandarin" checked>
    <label for="mandarin">普通话</label>
    <input type="radio" id="cantonese" name="language" value="cantonese">
    <label for="cantonese">粤语</label>
    <br><br>
    <button onclick="generateTTS()">生成语音</button>
    <script>
        async function generateTTS() {
            const inputText = document.getElementById('inputText').value.trim();
            const language = document.querySelector('input[name="language"]:checked').value;
            const apiKey = 'sk-TUSfPkH2BvShYbh8JXnrFGaRqsUreuM24BY6knI8lemI6ezV'; // 替换为 /home/u-shigc/LLM/2025.07.09_config.toml 中的 api_key
            const baseUrl = 'https://api.moonshot.cn/v1'; // 替换为 /home/u-shigc/LLM/2025.07.09_config.toml 中的 base_url

            if (!inputText) {
                alert('请输入文本！');
                return;
            }

            try {
                // 调用 Moonshot API 进行文本规范化
                const aiResponse = await fetch(`${baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'moonshot-v1-128k',
                        messages: [
                            {
                                role: 'system',
                                content: '将输入的中文句子进行汉语TTS的text normalization（进行汉语中数字与数量表达的规范化；数学、物理等符号的口语化转换；将所有非中文文本直接进行汉语音译（禁止翻译），使得转换后的句子中仅包含中文；最后返回转换后的句子。注意：输出的结果中不能出现英文或阿拉伯数字！不要输出任何的额外信息！'
                            },
                            { role: 'user', content: inputText }
                        ],
                        temperature: 0.3
                    })
                });
                if (!aiResponse.ok) {
                    throw new Error('文本预处理失败');
                }
                const aiData = await aiResponse.json();
                const normalizedText = aiData.choices[0].message.content;

                // 发送到后端 TTS 端点
                const ttsResponse = await fetch('http://114.212.87.202:5000/api/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: normalizedText, language: language })
                });
                if (!ttsResponse.ok) {
                    throw new Error('语音生成失败');
                }
                const ttsData = await ttsResponse.json();
                if (ttsData.audio_url) {
                    window.location.href = ttsData.audio_url; // 假设后端返回音频 URL 并跳转播放
                } else {
                    alert('语音生成成功，但未返回音频URL！');
                }
            } catch (error) {
                alert('错误：' + error.message);
            }
        }
    </script>
</body>
</html>